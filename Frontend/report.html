<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Your PHQ-9 Interview Reports</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background: #eaf4fb;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 40px 10px;
    }
    .container {
      background: #fff;
      border-radius: 18px;
      max-width: 670px;
      width: 100%;
      box-shadow: 0 6px 32px rgba(80,130,238,0.10), 0 1.5px 7px rgba(60,80,120,0.08);
      margin-top: 40px;
      padding: 32px 32px 40px;
      text-align: center;
    }
    h1 {
      font-size: 2.1rem;
      color: #213252;
      margin-bottom: 24px;
      font-weight: 700;
      letter-spacing: -.5px;
    }
    .main-actions {
      display: flex;
      justify-content: center;
      gap: 18px;
      margin-bottom: 22px;
      flex-wrap: wrap;
    }
    .main-actions button {
      background: #2563eb;
      color: white;
      font-size: 1.05rem;
      padding: 10px 24px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 8px rgba(60,80,120,0.08);
      transition: background 0.17s, transform 0.14s;
    }
    .main-actions button:hover {
      background: #1742a0;
      transform: translateY(-2px);
    }
    #download-all-btn {
      background: #047857;
      margin-left: 5px;
    }
    #download-all-btn:hover {
      background: #065f46;
    }
    .date-filter {
      display: none;
      margin-bottom: 18px;
      justify-content: center;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    .date-filter label {
      font-weight: 600;
      color: #2563eb;
      font-size: 1.01rem;
    }
    .date-filter input[type="date"] {
      font-size: 1rem;
      border: 1.5px solid #d0dbef;
      border-radius: 7px;
      padding: 6px 11px;
      outline: none;
      margin: 0 4px;
    }
    .date-filter button {
      background: #2563eb;
      color: white;
      font-size: 1rem;
      padding: 7px 18px;
      border: none;
      border-radius: 7px;
      font-weight: 600;
      margin-left: 4px;
      cursor: pointer;
      transition: background 0.17s;
    }
    .date-filter button:hover { background: #1742a0; }
    #report-list {
      margin-top: 18px;
      min-height: 65px;
    }
    .report-card {
      background: #f7fbff;
      border-radius: 14px;
      padding: 20px 25px 14px;
      box-shadow: 0 2px 10px rgba(36,79,150,0.08);
      margin-bottom: 20px;
      text-align: left;
      position: relative;
      transition: box-shadow .23s;
    }
    .report-card:hover {
      box-shadow: 0 5px 18px rgba(36,79,150,0.15);
    }
    .card-row {
      display: flex;
      align-items: center;
      margin-bottom: 9px;
      gap: 14px;
      flex-wrap: wrap;
    }
    .card-row .date {
      font-size: 1.08rem;
      color: #626e98;
      display: flex;
      align-items: center;
      gap: 7px;
    }
    .card-row .score-badge, .card-row .severity-badge {
      display: inline-block;
      font-size: 1.03rem;
      font-weight: 600;
      padding: 4px 16px;
      border-radius: 14px;
      margin-right: 6px;
      letter-spacing: 0.5px;
    }
    .score-badge { background: #d1fae5; color: #047857; }
    .severity-badge { background: #dbeafe; color: #2563eb; }
    .report-summary {
      color: #2e325a;
      font-size: 1.02rem;
      margin-top: 7px;
      line-height: 1.5;
      background: #e8eefc;
      padding: 9px 13px;
      border-radius: 9px;
      white-space: pre-line;
      font-family: inherit;
    }
    .empty { color: #a5aac0; font-size: 1.13rem; margin: 28px 0; }
    .back-btn {
      background: #2563eb;
      color: white;
      border: none;
      padding: 12px 30px;
      font-size: 1.07rem;
      border-radius: 9px;
      margin-top: 20px;
      cursor: pointer;
      font-weight: 600;
      box-shadow: 0 2px 10px rgba(36,79,150,0.07);
      transition: background 0.18s;
    }
    .back-btn:hover { background: #1e40af; }
    .report-card .main-actions {
      margin-top: 12px;
      background: #2563eb;
      color: #fff;
      font-size: 1rem;
      padding: 8px 18px;
      border-radius: 8px;
      border: none;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 6px rgba(36,79,150,0.08);
    }
    .report-card .main-actions:hover {
      background: #1742a0;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Your PHQ-9 Interview Reports</h1>
    <div class="main-actions">
      <button onclick="showLatest()">View Latest Report</button>
      <button onclick="showAll()">Show All Reports</button>
      <button onclick="revealDateFilter()">Filter by Date</button>
      <button onclick="downloadAllReportsPDF()" id="download-all-btn">Download All as PDF</button>
    </div>
    <div class="date-filter" id="dateFilter">
      <label for="start-date">From: </label>
      <input type="date" id="start-date" />
      <label for="end-date">To: </label>
      <input type="date" id="end-date" />
      <button onclick="filterReports()">Filter</button>
    </div>
    <div id="report-list"></div>
    <button class="back-btn" onclick="window.location.href='index.html'">‚¨ÖÔ∏è Back to Chat</button>
  </div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script>
  const BACKEND_URL = "http://localhost:5000";
  let displayedReports = []; // track currently visible reports

  function getAuthHeaders() {
    const token = localStorage.getItem("token");
    if (!token) {
      alert("Not logged in!");
      window.location.href = "auth.html";
    }
    return {
      "Content-Type": "application/json",
      Authorization: `Bearer ${token}`
    };
  }

  function formatDate(dt) {
    const date = new Date(dt);
    return date.toLocaleDateString(undefined, {
      year: 'numeric', month: 'short', day: 'numeric',
      hour: '2-digit', minute: '2-digit'
    });
  }

  function displayReports(reports) {
    displayedReports = reports; // <--- track current
    const list = document.getElementById('report-list');
    if (!reports || reports.length === 0) {
      list.innerHTML = "<div class='empty'>No reports found for this period.</div>";
      return;
    }
    let html = "";
    for (const [i, report] of reports.entries()) {
      let summaryClean = report.summary.replace(/^END\s*/i, '').trim();
      let reportId = `report-pdf-btn-${i}`;
      html += `
        <div class="report-card">
          <div class="card-row">
            <span class="date">üóìÔ∏è ${formatDate(report.date)}</span>
            <span class="score-badge">Score: ${report.score}</span>
            <span class="severity-badge">Severity: ${report.severity}</span>
          </div>
          <div class="report-summary">${summaryClean}</div>
          <button class="main-actions" id="${reportId}">Download as PDF</button>
        </div>
      `;
    }
    list.innerHTML = html;
    // Attach listeners for each single download
    for (const [i, report] of reports.entries()) {
      document.getElementById(`report-pdf-btn-${i}`).onclick = () =>
        downloadReportPDF(report);
    }
  }

  // Download a single report
  function downloadReportPDF(report) {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    let y = 15;
    doc.setFont("helvetica", "bold");
    doc.setFontSize(18);
    doc.text("PHQ-9 Interview Report", 14, y);

    doc.setFontSize(12);
    doc.setFont("helvetica", "normal");
    y += 12;
    doc.text(`Date: ${formatDate(report.date)}`, 14, y);

    y += 10;
    // Try backend name, else localStorage, else blank
    doc.text(`Name: ${report.name || localStorage.getItem("name") || "N/A"}`, 14, y);

    y += 10;
    doc.text(`Score: ${report.score || "N/A"}`, 14, y);
    y += 8;
    doc.text(`Severity: ${String(report.severity || "N/A").replace(/[^\w\s-]/g, "")}`, 14, y);

    y += 12;
    doc.setFont("helvetica", "bold");
    doc.text("Summary:", 14, y);

    doc.setFont("helvetica", "normal");
    y += 8;
    let summary = report.summary.replace(/^END\s*/i, '').trim();
    doc.setFontSize(11);
    const lines = doc.splitTextToSize(summary, 180);
    doc.text(lines, 14, y);

    doc.save(`PHQ9_Report_${new Date(report.date).toISOString().slice(0,10)}.pdf`);
  }

  // Download ALL reports shown
  function downloadAllReportsPDF() {
    if (!displayedReports || !displayedReports.length) {
      alert("No reports to download.");
      return;
    }
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    displayedReports.forEach((report, idx) => {
      let y = 15;
      doc.setFont("helvetica", "bold");
      doc.setFontSize(18);
      doc.text("PHQ-9 Interview Report", 14, y);

      doc.setFontSize(12);
      doc.setFont("helvetica", "normal");
      y += 12;
      doc.text(`Date: ${formatDate(report.date)}`, 14, y);

      y += 10;
      doc.text(`Name: ${report.name || localStorage.getItem("name") || "N/A"}`, 14, y);

      y += 10;
      doc.text(`Score: ${report.score || "N/A"}`, 14, y);
      y += 8;
      doc.text(`Severity: ${String(report.severity || "N/A").replace(/[^\w\s-]/g, "")}`, 14, y);

      y += 12;
      doc.setFont("helvetica", "bold");
      doc.text("Summary:", 14, y);

      doc.setFont("helvetica", "normal");
      y += 8;
      let summary = report.summary.replace(/^END\s*/i, '').trim();
      doc.setFontSize(11);
      const lines = doc.splitTextToSize(summary, 180);
      doc.text(lines, 14, y);

      if (idx !== displayedReports.length - 1) doc.addPage();
    });

    doc.save("PHQ9_Reports.pdf");
  }

  // Fetch latest report only
  async function showLatest() {
    hideDateFilter();
    document.getElementById('report-list').innerHTML = "Loading...";
    try {
      const res = await fetch(`${BACKEND_URL}/api/report`, { headers: getAuthHeaders() });
      const data = await res.json();
      if (!data || data.error) {
        displayReports([]);
        return;
      }
      displayReports([data]);
    } catch {
      displayReports([]);
    }
  }

  // Fetch all reports
  function showAll() {
    hideDateFilter();
    fetchReports("1970-01-01", "2100-01-01");
  }

  // Reveal date picker
  function revealDateFilter() {
    document.getElementById('dateFilter').style.display = 'flex';
    document.getElementById('report-list').innerHTML = "";
  }
  function hideDateFilter() {
    document.getElementById('dateFilter').style.display = 'none';
  }

  // Fetch reports in a date range
  async function fetchReports(start, end) {
    document.getElementById('report-list').innerHTML = "Loading...";
    let url = `${BACKEND_URL}/api/reports-by-date?start=${start}&end=${end}`;
    try {
      const res = await fetch(url, { headers: getAuthHeaders() });
      const data = await res.json();
      displayReports(data);
    } catch {
      displayReports([]);
    }
  }

  // Filter action from date picker
  function filterReports() {
    const start = document.getElementById("start-date").value;
    const end = document.getElementById("end-date").value;
    if (!start || !end) {
      alert("Select both start and end dates.");
      return;
    }
    fetchReports(start, end);
  }

  // Load latest report by default
  window.addEventListener("DOMContentLoaded", showLatest);
</script>
</body>
</html>
